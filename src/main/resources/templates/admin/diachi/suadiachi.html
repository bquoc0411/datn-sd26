<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="@{/assets/js/main.js}"></script>
</head>
<body>
<h2>CẬP NHẬT ĐỊA CHỈ</h2>
<form     th:action="@{/dia-chi/sua/{id}(id=${diaChi.id})}" th:object="${diaChi}" method="post">

    <div class="form-floating">
        <select class="form-select form-select-sm mb-3" id="city" aria-label="Chọn Tỉnh/Thành phố"
                th:field="*{tinh}">
            <option value="" selected>Chọn Tỉnh/Thành phố</option>
        </select>
    </div>

    <div class="form-floating">
        <select class="form-select form-select-sm mb-3" id="district" aria-label="Chọn Quận/Huyện"
                th:field="*{huyen}">
            <option value="" selected>Chọn Quận/Huyện</option>
        </select>
    </div>

    <div class="form-floating">
        <select class="form-select form-select-sm mb-3" id="ward" aria-label="Chọn Phường/Xã"
                th:field="*{xa}">
            <option value="" selected>Chọn Phường/Xã</option>
        </select>
    </div>

    <div class="form-floating mb-3">
        <input type="text" class="form-control" th:field="*{diaChiCuThe}" id="diaChiCuThe"   placeholder="Địa chỉ cụ thể">
        <label for="diaChiCuThe">Địa chỉ cụ thể</label>
        <div th:if="${#fields.hasErrors('diaChiCuThe')}" class="error">
            <i th:errors="*{diaChiCuThe}" class="text-danger"></i>
        </div>
    </div>

    <div class="form-floating">
        <input type="text" class="form-control" th:field="*{ghiChu}" id="ghiChu"  placeholder="Quốc gia">
        <label for="ghiChu">Ghi chú</label>
        <div th:if="${#fields.hasErrors('ghiChu')}" class="error">
            <i th:errors="*{ghiChu}" class="text-danger"></i>
        </div>
    </div>

    <button type="submit" class="btn btn-success btn-sm"
            onclick="return confirm('Bạn có chắc muốn sửa địa chỉ này?');">Lưu</button>
</form>



<script>
        var citis = document.getElementById("city");
        var districts = document.getElementById("district");
        var wards = document.getElementById("ward");

        var Parameter = {
            url: "https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json",
            method: "GET",
            responseType: "json",
        };

        axios(Parameter).then(function (response) {
            renderCity(response.data);
            setDefaultValues(response.data);
        }).catch(function (error) {
            console.error('Error fetching data: ', error);
        });

        function renderCity(data) {
            data.forEach(function (city) {
                citis.options[citis.options.length] = new Option(city.Name, city.Name);
            });

            citis.onchange = function () {
                clearOptions(districts);
                clearOptions(wards);

                var selectedCity = data.find(function (city) {
                    return city.Name === citis.value;
                });

                if (selectedCity) {
                    selectedCity.Districts.forEach(function (district) {
                        districts.options[districts.options.length] = new Option(district.Name, district.Name);
                    });
                }

                updateHiddenFields();
            };

            districts.onchange = function () {
                clearOptions(wards);

                var selectedCity = data.find(function (city) {
                    return city.Name === citis.value;
                });

                if (selectedCity) {
                    var selectedDistrict = selectedCity.Districts.find(function (district) {
                        return district.Name === districts.value;
                    });

                    if (selectedDistrict) {
                        selectedDistrict.Wards.forEach(function (ward) {
                            wards.options[wards.options.length] = new Option(ward.Name, ward.Name);
                        });
                    }
                }

                updateHiddenFields();
            };

            wards.onchange = function () {
                updateHiddenFields();
            };
        }

        function clearOptions(selectElement) {
            for (var i = selectElement.options.length - 1; i > 0; i--) {
                selectElement.remove(i);
            }
        }

        function updateHiddenFields() {
            var selectedCity = citis.options[citis.selectedIndex];
            var selectedDistrict = districts.options[districts.selectedIndex];
            var selectedWard = wards.options[wards.selectedIndex];

            document.querySelector("input[name='tinh']").value = selectedCity ? selectedCity.value : "";
            document.querySelector("input[name='huyen']").value = selectedDistrict ? selectedDistrict.value : "";
            document.querySelector("input[name='xa']").value = selectedWard ? selectedWard.value : "";
        }

        function setDefaultValues(data) {
            var defaultCity = document.querySelector("input[name='tinh']").value;
            var defaultDistrict = document.querySelector("input[name='huyen']").value;
            var defaultWard = document.querySelector("input[name='xa']").value;

            if (defaultCity) {
                citis.value = defaultCity;
                var selectedCity = data.find(function (city) {
                    return city.Name === defaultCity;
                });

                if (selectedCity) {
                    selectedCity.Districts.forEach(function (district) {
                        districts.options[districts.options.length] = new Option(district.Name, district.Name);
                    });

                    if (defaultDistrict) {
                        districts.value = defaultDistrict;
                        var selectedDistrict = selectedCity.Districts.find(function (district) {
                            return district.Name === defaultDistrict;
                        });

                        if (selectedDistrict) {
                            selectedDistrict.Wards.forEach(function (ward) {
                                wards.options[wards.options.length] = new Option(ward.Name, ward.Name);
                            });

                            if (defaultWard) {
                                wards.value = defaultWard;
                            }
                        }
                    }
                }
            }
        }
</script>
</form>
</body>
</html>