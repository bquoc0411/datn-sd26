<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Bahnschrift';
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .img-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            display: block;
            margin: auto;
            border: 3px solid #ddd;
        }

        input:focus, select:focus {
            border-color: #ff5733 !important;
            box-shadow: 0 0 5px rgba(255, 87, 51, 0.5) !important;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="card">
        <h3 class="text-center">Sửa Khách Hàng</h3>
        <form th:method="post" id="addForm"
              th:object="${khachHangDto}"
              th:action="@{/khach-hang/sua/{id}(id=${khachHangDto.id})}"
              enctype="multipart/form-data">
            <div class="row">
                <!-- Avatar Section -->
                <div class="col-md-4 text-center">
                    <h5>Ảnh Đại Diện</h5>
                    <img id="uploadedImage" class="img-preview"
                         th:src="@{/uploads/{imageName}(imageName=${khachHangDto.hinhAnh})}">
                    <input type="file" id="fileInput" class="form-control mt-2" name="anh"
                           accept="image/png, image/jpeg">
                </div>
                <!-- Info Section -->
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Tên khách hàng:</label>
                            <input type="text" class="form-control" th:field="*{tenKhachHang}" placeholder="Nhập tên">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Ngày sinh:</label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Giới tính:</label><br>
                            <input type="radio" value="true" th:field="*{gioiTinh}"> Nam
                            <input type="radio" value="false" th:field="*{gioiTinh}" class="ms-3"> Nữ
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Email:</label>
                            <input type="email" class="form-control" th:field="*{email}" placeholder="Nhập email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Số điện thoại:</label>
                            <input type="text" class="form-control" th:field="*{sdt}" placeholder="Nhập số điện thoại">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Trạng thái:</label>
                            <select class="form-control" th:field="*{trangThai}" disabled>
                                <option value="true">Hoạt động</option>
                                <option value="false">Ngừng hoạt động</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Section -->
            <h4 class="mt-4">Danh sách địa chỉ</h4>
            <div th:each="diaChi, iterStat : *{listDiaChi}" class="address-item">
                <h5>Địa chỉ số [[${iterStat.index + 1}]]</h5>
                <input type="radio" name="defaultAddress" value="${index}" id="default_${index}" class="form-check-input">
                <label >Đặt làm mặc định</label>

                <div class="col-auto">
                        <label class="col-form-label"><span style="color: red">* </span>Tỉnh/Thành
                            phố:</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-control form-select form-select-sm mb-3"
                                id="city"
                                th:field="*{listDiaChi[__${iterStat.index}__].tinh}"
                                aria-label=".form-select-sm">
                            <option value="" selected>Chọn tỉnh thành</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <p style="color: red; font-weight: initial;" id="errorTinh"></p>
                    </div>
                    <div class="col-auto">
                        <label class="col-form-label"><span style="color: red">* </span>Quận/Huyện:
                            phố:</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-control form-select form-select-sm mb-3"
                                id="district"
                                th:field="*{listDiaChi[__${iterStat.index}__].huyen}"
                                aria-label=".form-select-sm">
                            <option value="" selected>Chọn tỉnh thành</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <p style="color: red; font-weight: initial;" id="errorQuan"></p>
                    </div>


                    <div class="col-auto">
                        <label class="col-form-label"><span style="color: red">* </span>Xã/Phường:</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-control form-select form-select-sm"
                                id="ward"
                                th:field="*{listDiaChi[__${iterStat.index}__].xa}"
                                aria-label=".form-select-sm">
                            <option value="" selected>Chọn phường xã</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <p style="color: red; font-weight: initial;"
                           id="errorPhuong"></p>
                    </div>

                    <div class="col-auto">
                        <label class="col-form-label"><span style="color: red">* </span>Địa
                            chỉ cụ thể:</label>
                    </div>
                    <div class="col-auto">
                        <input class="form-control"
                               th:field="*{listDiaChi[__${iterStat.index}__].diaChiCuThe}"
                               id="inputDuong" placeholder="Tên Đường"
                               th:errorclass="is-invalid">
                    </div>
                    <div class="col-auto">
                        <p style="color: red; font-weight: initial;"
                           id="errorDuong"></p>
                    </div>
                <br>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeAddress(this)">
                        Xóa
                    </button>
                </div>
                </div>

            <div id="address-container"></div>
            <button type="button" id="addAddressBtn" class="btn btn-outline-primary mt-2" onclick="addAddressField()">
                <i class="bi bi-plus-circle"></i> Thêm Địa Chỉ
            </button>


            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-danger">Lưu</button>
                <a class="btn btn-dark" th:href="@{/khach-hang/hien-thi}">Thoát</a>
            </div>
        </form>
    </div>
</div>

</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addressContainer = document.getElementById("address-container");
        const addAddressBtn = document.getElementById("addAddressBtn");

        let provincesData = {};
        let districtsData = {};
        let wardsData = {};

        function fetchData(url, callback) {
            fetch(url)
                .then(response => response.json())
                .then(data => callback(data))
                .catch(error => console.error("Lỗi khi tải dữ liệu:", error));
        }

        function loadProvinces() {
            fetchData("https://provinces.open-api.vn/api/?depth=1", data => {
                data.forEach(province => {
                    provincesData[province.code] = province.name;
                });
            });
        }

        function getDistricts(provinceId, callback) {
            if (districtsData[provinceId]) {
                callback(districtsData[provinceId]);
            } else {
                fetchData(`https://provinces.open-api.vn/api/p/${provinceId}?depth=2`, data => {
                    districtsData[provinceId] = data.districts;
                    callback(data.districts);
                });
            }
        }

        function getWards(districtId, callback) {
            if (wardsData[districtId]) {
                callback(wardsData[districtId]);
            } else {
                fetchData(`https://provinces.open-api.vn/api/d/${districtId}?depth=2`, data => {
                    wardsData[districtId] = data.wards;
                    callback(data.wards);
                });
            }
        }

        function createDropdown(labelText, nameAttr) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("mb-3");

            const label = document.createElement("label");
            label.innerHTML = `<span class="text-danger">*</span> ${labelText}:`;
            wrapper.appendChild(label);

            const select = document.createElement("select");
            select.classList.add("form-select");
            select.name = nameAttr;
            select.innerHTML = `<option value="">Chọn ${labelText.toLowerCase()}</option>`;

            wrapper.appendChild(select);
            return {wrapper, select};
        }

        function addAddressField() {
            // Tính số lượng địa chỉ hiện có, bao gồm cả các địa chỉ đã có sẵn trong HTML
            const index = addressContainer.children.length + document.querySelectorAll(".address-item").length;
            const addressDiv = document.createElement("div");
            addressDiv.classList.add("border", "p-3", "mb-3");

            // Thêm số thứ tự địa chỉ
            const header = document.createElement("h5");
            header.textContent = `Địa chỉ số ${index + 1}`;
            addressDiv.appendChild(header);

            // Checkbox "Mặc định"
            const defaultCheckboxDiv = document.createElement("div");
            defaultCheckboxDiv.classList.add("mb-3");
            defaultCheckboxDiv.innerHTML = `
        <input type="radio" name="defaultAddress" value="${index}" id="default_${index}" class="form-check-input">
        <label for="default_${index}">Đặt làm mặc định</label>
        <input type="hidden" name="listDiaChi[${index}].macDinh" value="false" id="hiddenDefault_${index}">
    `;
            addressDiv.appendChild(defaultCheckboxDiv);

            // Khi chọn làm mặc định, bỏ chọn các địa chỉ khác
            defaultCheckboxDiv.querySelector("input").addEventListener("change", function () {
                document.querySelectorAll('input[name="defaultAddress"]').forEach(input => {
                    const index = input.value;
                    document.getElementById(`hiddenDefault_${index}`).value = "false";
                });
                document.getElementById(`hiddenDefault_${index}`).value = "true";
            });
            addressContainer.appendChild(addressDiv);

            // Dropdown tỉnh
            const {
                wrapper: provinceWrapper,
                select: provinceSelect
            } = createDropdown("Tỉnh/Thành phố", `listDiaChi[${index}].tinh`);
            addressDiv.appendChild(provinceWrapper);

            // Dropdown quận/huyện
            const {
                wrapper: districtWrapper,
                select: districtSelect
            } = createDropdown("Quận/Huyện", `listDiaChi[${index}].huyen`);
            addressDiv.appendChild(districtWrapper);

            // Dropdown xã/phường
            const {wrapper: wardWrapper, select: wardSelect} = createDropdown("Xã/Phường", `listDiaChi[${index}].xa`);
            addressDiv.appendChild(wardWrapper);

            // Ô nhập địa chỉ cụ thể
            const addressInputDiv = document.createElement("div");
            addressInputDiv.classList.add("mb-3");
            addressInputDiv.innerHTML = `
            <label><span class="text-danger">*</span> Địa chỉ cụ thể:</label>
            <input type="text" class="form-control" name="listDiaChi[${index}].diaChiCuThe" placeholder="Nhập số nhà, đường...">
        `;
            addressDiv.appendChild(addressInputDiv);

            addressContainer.appendChild(addressDiv);

            // Nút xóa địa chỉ
            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            deleteButton.textContent = "Xóa";
            deleteButton.addEventListener("click", function () {
                addressDiv.remove();
            });

            addressDiv.appendChild(deleteButton);
            addressContainer.appendChild(addressDiv);

            // Load tỉnh
            for (const [id, name] of Object.entries(provincesData)) {
                const option = document.createElement("option");
                option.value = id;
                option.textContent = name;
                provinceSelect.appendChild(option);
            }

            // Khi chọn tỉnh -> load quận/huyện
            provinceSelect.addEventListener("change", function () {
                districtSelect.innerHTML = `<option value="">Chọn quận/huyện</option>`;
                wardSelect.innerHTML = `<option value="">Chọn xã/phường</option>`;
                if (this.value) {
                    getDistricts(this.value, districts => {
                        districts.forEach(district => {
                            const option = document.createElement("option");
                            option.value = district.code;
                            option.textContent = district.name;
                            districtSelect.appendChild(option);
                        });
                    });
                }
            });

            // Khi chọn quận/huyện -> load xã/phường
            districtSelect.addEventListener("change", function () {
                wardSelect.innerHTML = `<option value="">Chọn xã/phường</option>`;
                if (this.value) {
                    getWards(this.value, wards => {
                        wards.forEach(ward => {
                            const option = document.createElement("option");
                            option.value = ward.code;
                            option.textContent = ward.name;
                            wardSelect.appendChild(option);
                        });
                    });
                }
            });
        }

        addAddressBtn.addEventListener("click", addAddressField);

        // Load dữ liệu tỉnh ban đầu
        loadProvinces();

    });

    function removeAddress(button) {
        const addressDiv = button.parentElement;
        addressDiv.remove();
    }
    function loadProvinces() {
        fetchData("https://provinces.open-api.vn/api/?depth=1", data => {
            if (data && data.length > 0) {
                data.forEach(province => {
                    const option = document.createElement("option");
                    option.value = province.code;
                    option.textContent = province.name;
                    document.getElementById("city").appendChild(option);
                });
            }
        });
    }

</script>
</html>
