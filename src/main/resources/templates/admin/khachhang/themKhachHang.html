<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Bahnschrift';
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .img-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            display: block;
            margin: auto;
            border: 3px solid #ddd;
        }

        input:focus, select:focus {
            border-color: #ff5733 !important;
            box-shadow: 0 0 5px rgba(255, 87, 51, 0.5) !important;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="card">
        <h3 class="text-center">Thêm Khách Hàng</h3>
        <form th:method="post" id="addForm" th:object="${khachHangDto}" th:action="@{/khach-hang/them}"
              enctype="multipart/form-data">
            <div class="row">
                <!-- Avatar Section -->
                <div class="col-md-4 text-center">
                    <h5>Ảnh Đại Diện</h5>
                    <img id="uploadedImage" class="img-preview"
                         th:src="@{/uploads/{imageName}(imageName=${khachHangDto.hinhAnh})}">
                    <input type="file" id="fileInput" class="form-control mt-2" name="anh"
                           accept="image/png, image/jpeg">
                </div>
                <!-- Info Section -->
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Tên khách hàng:</label>
                            <input type="text" class="form-control" th:field="*{tenKhachHang}" placeholder="Nhập tên">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Ngày sinh:</label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Giới tính:</label><br>
                            <input type="radio" value="true" th:field="*{gioiTinh}"> Nam
                            <input type="radio" value="false" th:field="*{gioiTinh}" class="ms-3"> Nữ
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Email:</label>
                            <input type="email" class="form-control" th:field="*{email}" placeholder="Nhập email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Số điện thoại:</label>
                            <input type="text" class="form-control" th:field="*{sdt}" placeholder="Nhập số điện thoại">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Trạng thái:</label>
                            <select class="form-control" th:field="*{trangThai}" disabled>
                                <option value="true">Hoạt động</option>
                                <option value="false">Ngừng hoạt động</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Section -->
            <h5 class="mt-4">Địa chỉ</h5>
            <div id="address-container"></div>
            <button type="button" id="addAddressBtn" class="btn btn-outline-primary mt-2" onclick="addAddressField()">
                <i class="bi bi-plus-circle"></i> Thêm Địa Chỉ
            </button>


            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-danger">Lưu</button>
                <a class="btn btn-dark" th:href="@{/nhan-vien/hien-thi}">Thoát</a>
            </div>
        </form>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const addressContainer = document.getElementById("address-container");
        const addAddressBtn = document.getElementById("addAddressBtn");

        let addressData = [];
        let provinceMap = new Map();

        async function fetchData() {
            try {
                const response = await fetch("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json");
                addressData = await response.json();
                addressData.forEach(province => provinceMap.set(province.Name, province));
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
            }
        }

        function createDropdown(labelText, nameAttr) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("mb-3");

            const label = document.createElement("label");
            label.innerHTML = `<span class="text-danger">*</span> ${labelText}:`;
            wrapper.appendChild(label);

            const select = document.createElement("select");
            select.classList.add("form-select");
            select.name = nameAttr;
            select.innerHTML = `<option value="">Chọn ${labelText.toLowerCase()}</option>`;

            wrapper.appendChild(select);
            return { wrapper, select };
        }

        function addAddressField() {
            const index = addressContainer.children.length;
            const addressDiv = document.createElement("div");
            addressDiv.classList.add("border", "p-3", "mb-3");

            // Tiêu đề
            const header = document.createElement("h5");
            header.textContent = `Địa chỉ số ${index + 1}`;
            addressDiv.appendChild(header);

            // Checkbox "Mặc định"
            const defaultCheckboxDiv = document.createElement("div");
            defaultCheckboxDiv.classList.add("mb-3");
            defaultCheckboxDiv.innerHTML = `
            <input type="radio" name="defaultAddress" value="${index}" id="default_${index}" class="form-check-input">
            <label for="default_${index}">Đặt làm mặc định</label>
            <input type="hidden" name="listDiaChi[${index}].macDinh" value="false" id="hiddenDefault_${index}">
        `;
            addressDiv.appendChild(defaultCheckboxDiv);

            // Thêm vào DOM trước khi truy cập hiddenDefault
            addressContainer.appendChild(addressDiv);

            // Gán sự kiện khi chọn làm mặc định
            const defaultRadio = document.getElementById(`default_${index}`);
            const hiddenDefaultInput = document.getElementById(`hiddenDefault_${index}`);

            if (index === 0) {
                defaultRadio.checked = true;
                hiddenDefaultInput.value = "true";
            }

            defaultRadio.addEventListener("change", function () {
                document.querySelectorAll('input[name="defaultAddress"]').forEach(input => {
                    document.getElementById(`hiddenDefault_${input.value}`).value = "false";
                });
                hiddenDefaultInput.value = "true";
            });

            // Dropdown tỉnh/huyện/xã
            const { wrapper: provinceWrapper, select: provinceSelect } = createDropdown("Tỉnh/Thành phố", `listDiaChi[${index}].tinh`);
            addressDiv.appendChild(provinceWrapper);

            const { wrapper: districtWrapper, select: districtSelect } = createDropdown("Quận/Huyện", `listDiaChi[${index}].huyen`);
            addressDiv.appendChild(districtWrapper);

            const { wrapper: wardWrapper, select: wardSelect } = createDropdown("Xã/Phường", `listDiaChi[${index}].xa`);
            addressDiv.appendChild(wardWrapper);

            // Ô nhập địa chỉ cụ thể
            const addressInputDiv = document.createElement("div");
            addressInputDiv.classList.add("mb-3");
            addressInputDiv.innerHTML = `
            <label><span class="text-danger">*</span> Địa chỉ cụ thể:</label>
            <input type="text" class="form-control" name="listDiaChi[${index}].diaChiCuThe" placeholder="Nhập số nhà, đường...">
        `;
            addressDiv.appendChild(addressInputDiv);

            // Nút xóa địa chỉ
            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.classList.add("btn", "btn-danger", "btn-sm", "mt-2");
            deleteButton.textContent = "Xóa";
            deleteButton.addEventListener("click", function () {
                const isDefault = defaultRadio.checked;
                addressDiv.remove();

                const remainingAddresses = document.querySelectorAll('input[name="defaultAddress"]');
                if (isDefault && remainingAddresses.length > 0) {
                    remainingAddresses[0].checked = true;
                    document.getElementById(`hiddenDefault_${remainingAddresses[0].value}`).value = "true";
                }
            });

            addressDiv.appendChild(deleteButton);

            // Load tỉnh/thành phố
            addressData.forEach(province => {
                const option = document.createElement("option");
                option.value = province.Name;
                option.textContent = province.Name;
                provinceSelect.appendChild(option);
            });

            // Khi chọn tỉnh -> load quận/huyện
            provinceSelect.addEventListener("change", function () {
                districtSelect.innerHTML = `<option value="">Chọn quận/huyện</option>`;
                wardSelect.innerHTML = `<option value="">Chọn xã/phường</option>`;

                const selectedProvince = provinceMap.get(this.value);
                if (selectedProvince) {
                    selectedProvince.Districts.forEach(district => {
                        const option = document.createElement("option");
                        option.value = district.Name;
                        option.textContent = district.Name;
                        districtSelect.appendChild(option);
                    });
                }
            });

            // Khi chọn quận/huyện -> load xã/phường
            districtSelect.addEventListener("change", function () {
                wardSelect.innerHTML = `<option value="">Chọn xã/phường</option>`;

                const selectedProvince = provinceMap.get(provinceSelect.value);
                if (selectedProvince) {
                    const selectedDistrict = selectedProvince.Districts.find(d => d.Name === this.value);
                    if (selectedDistrict) {
                        selectedDistrict.Wards.forEach(ward => {
                            const option = document.createElement("option");
                            option.value = ward.Name;
                            option.textContent = ward.Name;
                            wardSelect.appendChild(option);
                        });
                    }
                }
            });
        }

        addAddressBtn.addEventListener("click", addAddressField);
        fetchData();
    });

</script>
</body>
</html>
